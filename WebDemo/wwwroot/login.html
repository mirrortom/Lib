<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name=viewport content="width=device-width,initial-scale=1.0" />
  <link href="mirrorui.css" rel="stylesheet" />
  <title>login</title>
</head>
<body class="bg-gray-2">
  <div id="loginBox"></div>

  <template id="loginTpl">
    <div class="layout-v mg-lr-auto pd-tb-15 bd bg-white-0" style="margin-top:25vh;max-width:320px">
      <div class="text-center">
        <span class="text-xl">${title}</span>
      </div>
      <div>
        <hr class="line mg-tb-15 bd-sky-5" />
      </div>
      <div class="mg-b-15 pd-lr-15">
        <label class="form-label mg-b-2">${idLabel}</label>
        <input class="input-text sky" id="login_account" name="account" type="text" value="" placeholder="${idDesc}" tabindex="1" vtype="notnull|minlen" verrmsg="${idErrMsg}" minlength="4" maxlength="40">
      </div>
      <div class="mg-b-15 pd-lr-15">
        <label class="form-label mg-b-2">${pwdLabel}</label>
        <input class="input-text sky" id="login_pwd" name="pwd" type="password" value="" placeholder="${pwdDesc}" tabindex="2" vtype="notnull|minlen" verrmsg="${pwdErrMsg}" minlength="4" maxlength="40">
      </div>
      <div class="layout-h f-h-sb mg-b-15 pd-lr-15">
        <m-check id="userAgree" class="sky" tag="${userAgreeTag}" vtype="agree" verrmsg="${userAgreeErrMsg}" tabindex="3"></m-check>
        <m-btn id="userAgreeBtn" class="link" tplid="${userAgreeLinkTplId}">${userAgreeLinkTxt}</m-btn>
      </div>
      <div class="mg-b-15 pd-lr-15">
        <m-btn class="d-block sky text-md" id="loginBtn">${submitBtnTxt}</m-btn>
      </div>
      <div class="layout-h f-h-sb mg-b-10 pd-lr-15">
        <m-check id="remembercheck" class="sky" tag="${stayLoginTag}" title="${stayLoginTitle}" tabindex="4"></m-check>
        <m-btn class="link">${resetPwdBtnTxt}</m-btn>
      </div>
      <m-msgshow id="msginfobox"></m-msgshow>
    </div>
  </template>
  <template id="userAgreeTpl">
    <div class="bg-white-0 bd bd-sky-5 pd-lr-20" style="max-width:400px;max-height:400px;overflow-y:auto">
      <h4 class="text-center">用户协议</h4>
      <ul class="list num">
        <li><p>以下简称:"协议","系统","你",分别表示本公司用户协议,本公司系统,本公司系统的使用方.当你使用系统时,表示你已经同意协议内容.</p></li>
        <li><p>当你使用系统时,请遵守中国相关法律法规.如果违法违规使用系统,无论是否造成损失,公司有权拒绝提供服务,并保留起诉权力.</p></li>
        <li><p>当你使用系统时,获得的是系统的使用权,如果你对系统的任何非你干预部分,进行任何改动,视为对系统的破环,包括但不限于:修改文件,反编译,破解等行为.公司有权拒绝服务,并保留起诉权力.</p></li>
        <li><p>当你使用系统时,应注意信息安全问题,系统的数据加密后存放和传输,尽可能的保证数据安全.但你在使用过程中,由于疏忽导致的泄密,包括但不限于:数据导出后未妥善保管,屏幕拍照,使用外挂,网络攻击等行为.公司免于承担责任,有权拒绝服务.</p></li>
        <li><p>当你使用系统时,遇到不可抗拒的自然力或者权力体,导致系统故障,包括但不限于:地震,洪水,台风,战争,权力机关介入等情况.公司免于承担责任.有权拒绝服务.</p></li>
        <li><p>当你使用系统时,遇到的任何问题,欢迎通过公司客服进行咨询,公司将积极解决.</p></li>
      </ul>
      <div class="text-center pd-15">
        <m-btn class="btn sky text-md" onclick="window.ns.msgbox.close()">关闭</m-btn>
      </div>
    </div>
  </template>
  <template id="userAgreeEnTpl">
    <div class="bg-white-0 bd bd-sky-5 pd-lr-20" style="max-width:400px;max-height:400px;overflow-y:auto">
      <h4 class="text-center">User Agreement</h4>
      <ul class="list num">
        <li><p>Hereinafter referred to as "Agreement", "System", "you", and "you", respectively, refers to the Company's User Agreement, the Company's System, and the User of the Company's System. When you use the system, you agree to the agreement.</p></li>
        <li><p>When you use the system, please comply with the relevant laws and regulations of China. In case of illegal use of the system, regardless of whether it causes damage, the company has the right to refuse to provide the service and reserves the right to sue.</p></li>
        <li><p>When you use the system, you get the right to use the system, if you make any changes to any part of the system that is not your intervention, it will be regarded as a break to the system, including but not limited to: modifying files, decompiling, cracking and other behaviors. The Company reserves the right to refuse service and reserves the right to sue.</p></li>
        <li><p>When you use the system, you should pay attention to information security, and store and transmit the data of the system after encryption to ensure data security as much as possible. However, the leakage caused by your negligence in the process of use, including but not limited to: not keeping the data properly after exporting, taking pictures on the screen, using plug-ins, network attacks, etc. The Company is exempt from liability and has the right to refuse service.</p></li>
        <li><p>When you use the system, you encounter irresistible natural forces or powers that cause system failures, including but not limited to: earthquakes, floods, typhoons, wars, and the intervention of authorities. The company is exempt from liability. Right to refuse service.</p></li>
        <li><p>When you use the system, any problems encountered, welcome to consult through the company's customer service, the company will actively solve.</p></li>
      </ul>
      <div class="text-center pd-15">
        <m-btn class="btn sky text-md" onclick="window.ns.msgbox.close()">Close</m-btn>
      </div>
    </div>
  </template>
  <script src="mirrorui.js"></script>
  <script src="jslib.js"></script>
  <script>
    ((win) => {
      // help
      let postAsync = $.postAsync;
      let formCheck = $.formCheck;
      let msgbox = win.ns.msgbox;
      let msg;

      //== init ==//
      formUIInit(1);
      // checkLogin();

      //== event ==//
      // login Btn
      $('#loginBtn').click(thisBtn => {
        login(thisBtn);
      });
      // 按回车登录
      $('#loginBox').addEvent('keyup', (event) => {
        if (event.code == 'Enter') {
          $('#loginBtn').click();
        }
      });
      // 复选按钮可以通过空格键操作
      $('#remembercheck,#userAgree').addEvent('keyup', (event) => {
        if (event.code == 'Space') {
          event.target.checked = !event.target.checked;
        }
      });
      // 用户协议弹出框
      $('#userAgreeBtn').click((ele) => {
        let tplId = $(ele).prop('tplid');
        let html = $('#' + tplId).html();
        msgbox.show(html);
      });

      //== functions ==//
      async function login(thisBtn) {
        msg.clear();
        let para = checkForm();
        console.log(para);
        if (checkForm() == false) return;
        if (thisBtn.isLoading()) {
          return;
        }
        try {
          //let data = await postAsync(cfg.ApiLogin, para);
          let data = { errcode: 201, msg: 'test info: error!' }
          if (data.errcode == 200) {
            // accessToken 设置
            // token.newToken(data.token);
            $('#login_pwd').val('')
            msg.ok('登录成功!跳转中...');
            //
            //setTimeout(() => {
            //  location.href = data.target + '.html';
            //}, 1500)
          } else {
            msg.err(data.msg);
          }
          thisBtn.clsLoading(1500);
        } catch (err) {
          msg.err(err.message);
          thisBtn.clsLoading(1500);
        }
      }

      function checkForm() {
        $.formClear($('#login_account')[0]);
        $.formClear($('#login_pwd')[0]);
        if (formCheck($('#login_account')[0]) == false)
          return false;
        if (formCheck($('#login_pwd')[0]) == false)
          return false;
        if (formCheck($('#userAgree')[0]) == false) {
          return false;
        }
        return {
          pwd: btoa($('#login_pwd').val()), account: $('#login_account').val(),
          remember: $('#remembercheck')[0].checked ? 1 : 0
        };
      }

      // 检查token,有效直接进入页面.无效不动作.
      async function checkLogin() {
        let tk = token.get();
        if (tk == null) return;
        let para = { token: tk, client: common.getClientType() };
        // 服务端检查
        try {
          let data = await postAsync(cfg.ApiTokenCheck, para)
          if (data.errcode == 200) {
            // 已经登录!跳转中...
            setTimeout(() => {
              location.href = data.target + '.html';
            }, 500)
          }
        } catch (e) {

        }
      }

      function formUIInit(type = 'cn') {
        let data = {
          title: '系 统 登 录/注 册',
          idLabel: '手机 / 账号 / 邮箱', idDesc: '请输入账号.', idErrMsg: '必填项|至少4个字符',
          pwdLabel: '密码', pwdDesc: '请输入密码.', pwdErrMsg: '必填项|至少4个字符',
          userAgreeTag: '同意协议', userAgreeLinkTxt: '阅读用户协议', userAgreeErrMsg: '请阅读并同意用户协议',
          userAgreeLinkTplId: 'userAgreeTpl',
          stayLoginTag: '7天免登录', stayLoginTitle: '7天内保持登录状态.',
          submitBtnTxt: '确 定', resetPwdBtnTxt: '找回密码'
        };
        let dataEn = {
          title: 'System Login/Register',
          idLabel: 'Phone Numer / ID / Mail', idDesc: 'Enter Account.', idErrMsg: 'require|min 4 chars',
          pwdLabel: 'Password', pwdDesc: 'Enter Password.', pwdErrMsg: 'require|min 4 chars',
          userAgreeTag: 'User Agree', userAgreeLinkTxt: 'Read User Agreement', userAgreeErrMsg: 'Please read and agree to the User Agreement',
          userAgreeLinkTplId: 'userAgreeEnTpl',
          stayLoginTag: '7 days stay logged', stayLoginTitle: 'Stay logged in for 7 days.',
          submitBtnTxt: 'Sure', resetPwdBtnTxt: 'Reset Password'
        };
        //
        let tpl = $('#loginTpl').html();
        let html = $.dataBind(tpl, type == 'cn' ? data : dataEn);
        $('#loginBox').html(html);
        //
        msg = $('#msginfobox')[0];
        msg.clear();
      }
    })(window);
  </script>
</body>
</html>